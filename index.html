<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>LWCAPI API Reference</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight, .highlight .w {
  color: #f8f8f2;
  background-color: #272822;
}
.highlight .err {
  color: #151515;
  background-color: #ac4142;
}
.highlight .c, .highlight .cd, .highlight .cm, .highlight .c1, .highlight .cs {
  color: #505050;
}
.highlight .cp {
  color: #f4bf75;
}
.highlight .nt {
  color: #f4bf75;
}
.highlight .o, .highlight .ow {
  color: #d0d0d0;
}
.highlight .p, .highlight .pi {
  color: #d0d0d0;
}
.highlight .gi {
  color: #90a959;
}
.highlight .gd {
  color: #ac4142;
}
.highlight .gh {
  color: #6a9fb5;
  background-color: #151515;
  font-weight: bold;
}
.highlight .k, .highlight .kn, .highlight .kp, .highlight .kr, .highlight .kv {
  color: #aa759f;
}
.highlight .kc {
  color: #d28445;
}
.highlight .kt {
  color: #d28445;
}
.highlight .kd {
  color: #d28445;
}
.highlight .s, .highlight .sb, .highlight .sc, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .s1 {
  color: #90a959;
}
.highlight .sr {
  color: #75b5aa;
}
.highlight .si {
  color: #8f5536;
}
.highlight .se {
  color: #8f5536;
}
.highlight .nn {
  color: #f4bf75;
}
.highlight .nc {
  color: #f4bf75;
}
.highlight .no {
  color: #f4bf75;
}
.highlight .na {
  color: #6a9fb5;
}
.highlight .m, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mb, .highlight .mx {
  color: #90a959;
}
.highlight .ss {
  color: #90a959;
}
    </style>
    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
      <script src="javascripts/all.js"></script>
  </head>

  <body class="index" data-languages="[&quot;json&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" />
      </span>
    </a>
    <div class="tocify-wrapper">
      <div id="logo">
      </div>
        <div class="lang-selector">
              <a href="#" data-language-name="json">json</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc">
      </div>
        <ul class="toc-footer">
            <li><a href='https://github.com/tripit/slate'>Documentation Powered by Slate</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id="introduction">Introduction</h1>

<p>atlas-lwcapi is a RESTful stateless service to allow applications which do
not use the Java JVM publish statistics in a streaming manner to Atlas, Mantis,
or any receiver which can process an SSE stream.</p>

<h1 id="lwcapi">LWCAPI</h1>

<h2 id="retrieve-client-expressions">Retrieve Client Expressions</h2>

<p>Clients should periodically retrieve a list of which expressions are
specifically subscribed by an active listener.</p>

<h3 id="http-request">HTTP Request</h3>

<p><code class="prettyprint">GET http://&lt;ELB-ENDPOINT&gt;/lwc/api/v1/expressions/&lt;CLUSTERID&gt;</code></p>

<h3 id="url-parameters">URL Parameters</h3>

<table><thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>CLUSTERID</td>
<td>The cluster-id for this application.</td>
</tr>
</tbody></table>

<h3 id="example-response">Example Response</h3>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://..."</span><span class="p">,</span><span class="w">
  </span><span class="nt">"frequency"</span><span class="p">:</span><span class="w"> </span><span class="mi">60000</span><span class="p">,</span><span class="w">
  </span><span class="nt">"expressions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tQTQF62tsAZCdyC73Rd0IQgZ5Y0"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"expression"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nf.cluster,skan-test,:eq,name,totalCpu,:eq,:and,:count,(,someMetric,),:by"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"frequency"</span><span class="p">:</span><span class="w"> </span><span class="mi">10000</span><span class="w">
    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"asdkqlkfktjrflsjflkwjflkjkd"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"expression"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nf.cluster,skan-test,:eq,name,totalCpu,:eq,:and,:sum"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://..."</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<table><thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>url</td>
<td>The default URL for all expressions, or specific per-expression overrides.</td>
</tr>
<tr>
<td>id</td>
<td>Opaque token used to identify the specific expression requested.  This will be sent with evaluation requests.</td>
</tr>
<tr>
<td>frequency</td>
<td>How often this data item should be sent to the evaluation endpoint, in milliseconds.  If an expression does not provide a value, use the top-level value.</td>
</tr>
<tr>
<td>expressions</td>
<td>Specific data expressions for the client to send.</td>
</tr>
<tr>
<td>destination</td>
<td>The named destination to send data for this expression.  If not specified, use the &ldquo;default&rdquo; endpoint.</td>
</tr>
</tbody></table>

<h2 id="evaluate-expressions">Evaluate Expressions</h2>

<p>Clients post data periodically to the evaluate endpoint.</p>

<h3 id="http-request">HTTP Request</h3>

<p><code class="prettyprint">POST http://&lt;ELB-ENDPOINT&gt;/lwc/api/v1/evaluate</code></p>

<aside class="notice">
 Note: The actual URL specified in the client expression list should be used.
</aside>

<h3 id="example-request">Example Request</h3>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="mi">12345</span><span class="p">,</span><span class="w">
  </span><span class="nt">"expressions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tQTQF62tsAZCdyC73Rd0IQgZ5Y0"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="nt">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">"someMetric"</span><span class="p">:</span><span class="w"> </span><span class="s2">"value1"</span><span class="p">},</span><span class="w"> </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">123</span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="nt">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">"someMetric"</span><span class="p">:</span><span class="w"> </span><span class="s2">"value2"</span><span class="p">},</span><span class="w"> </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">456</span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"asdkqlkfktjrflsjflkwjflkjkd"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="nt">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">123</span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>Data may be partitioned by sending multiple payloads with expression objects.  A single expression object may also be
split into multiple payloads if needed.</p>

<table><thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>timestamp</td>
<td>The timestamp to apply to all the expressions in this payload.</td>
</tr>
<tr>
<td>expressions</td>
<td>Specific data expressions, sent as a unit to evaluation requests.  If this is an empty string, it is a placeholder.</td>
</tr>
<tr>
<td>id</td>
<td>Opaque token used to identify the specific expression requested.  This field may be repeated if needed to partition a large return set.</td>
</tr>
<tr>
<td>data</td>
<td>An array of data which partially or completely provides data for an expression.</td>
</tr>
<tr>
<td>tags</td>
<td>tag/value pairs which allow the expression to be processed.</td>
</tr>
<tr>
<td>value</td>
<td>A single floating-point value</td>
</tr>
</tbody></table>

<h3 id="example-response">Example Response</h3>

<p>No response body is returned.</p>

<h2 id="stream-request">Stream Request</h2>

<p>Request an SSE stream of subscribed-to data.</p>

<p>Stream IDs should be durable for a given consumer&rsquo;s lifetime.  Only one connection per ID is allowed to each instance.
If the same ID is re-used, it will cause the older connection to be dropped.</p>

<p>For instance, a Mantis job may choose to use stream ID &ldquo;myStreamId1&rdquo; for each connection made.  If a connection is lost, or a
new lwcapi instance is detected, the same ID should be used.  However, if the mantis job were to restart or be replaced by a
newer version, it should use a different ID.</p>

<p>If the <code class="prettyprint">expr</code> field is provided, it will be automatically subscribed to, using the optionally provided <code class="prettyprint">frequency</code>.
If more than one expression is needed, addiitonal &ldquo;Subscribe To Expression&rdquo; calls may be made to add them.  Note that
this process will need to be repeated on connection loss: Stream Request followed by any additional Subscribe to Expressions
requests.</p>

<h3 id="http-request">HTTP Request</h3>

<p><code class="prettyprint">GET http://&lt;INSTANCE-ENDPOINT&gt;/lwc/api/v1/stream/&lt;ID&gt;?...</code></p>

<p>Applications should use Discovery to find all lwcapi instances in their region and stack, and connect to each.</p>

<aside class="notice">
 Note:  This connection should be made to each instance, not to the ELB endpoint.
</aside>

<h3 id="query-parameters">Query Parameters</h3>

<table><thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>name</td>
<td>A human-readable name for this stream, such as &ldquo;alert group foo&rdquo; or some other helpful information.</td>
</tr>
<tr>
<td>expr</td>
<td>An Atlas stack expression to subscribe to.</td>
</tr>
<tr>
<td>frequency</td>
<td>If expr is provided, request that the client report this often, in milliseconds.</td>
</tr>
</tbody></table>

<h3 id="stream-contents">Stream Contents</h3>

<p>The response is a continous stream of housekeeping and expression evaluation data.</p>

<p>All responses are SSE events, beginning with <code class="prettyprint">data:</code>, an event type, and JSON formatted event type-specific data.
Events are separated by a blank line.</p>

<aside class="notice">
  Note: While all the JSON examples here are multi-line, the data events sent to the stream are all on one line.
</aside>

<h4 id="data-hello">data: hello</h4>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"streamId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"yourStreamId"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"instanceId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"i-3259129e91e"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"instanceUUID"</span><span class="p">:</span><span class="w"> </span><span class="s2">"55037c3f-600a-4153-8a70-55ef2150bbfe"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<table><thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>streamId</td>
<td>The stream ID, echoed from the URL.</td>
</tr>
<tr>
<td>instanceId</td>
<td>The instanceId serving this data stream.  This is for debugging.</td>
</tr>
<tr>
<td>instanceUUID</td>
<td>The instance&rsquo;s current UUID.  This is for debugging.</td>
</tr>
</tbody></table>

<h4 id="data-heartbeat">data: heartbeat</h4>

<p>A heartbeat is periodically sent to ensure connections are not idle forever.</p>
<pre class="highlight json"><code><span class="p">{}</span><span class="w">
</span></code></pre>

<p>Currently this is an empty JSON object response.</p>

<h4 id="data-subscribe">data: subscribe</h4>

<p>This event is sent once for each subscription.</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"expression"</span><span class="p">:</span><span class="w"> </span><span class="s2">"name,foo,:eq,nf.app,skan,:eq,:and,:avg"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"frequency"</span><span class="p">:</span><span class="w"> </span><span class="mi">60000</span><span class="p">,</span><span class="w">
  </span><span class="nt">"dataExpressions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"aldjalkdsjalksjdalskdj"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"expression"</span><span class="p">:</span><span class="w"> </span><span class="s2">"name,foo:eq,nf.app,skan,:eq,:and,:count"</span><span class="w">
    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"523ljdlk2j3dlkj23lkjdk"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"expression"</span><span class="p">:</span><span class="w"> </span><span class="s2">"name,foo:eq,nf.app,skan,:eq,:and,:sum"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<table><thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>requestedExpression</td>
<td>The expression subscribed to.</td>
</tr>
<tr>
<td>frequency</td>
<td>The frequency, in milliseconds, this expression will be reported.</td>
</tr>
<tr>
<td>expressions</td>
<td>A list of data expressions generated from the requestedExpression.</td>
</tr>
<tr>
<td>id</td>
<td>The identifier which each data expression will be identified by.</td>
</tr>
<tr>
<td>expression</td>
<td>The data expression itself.</td>
</tr>
</tbody></table>

<p>When data arives, it is identified by the <code class="prettyprint">id</code> field.  See <code class="prettyprint">evaluate</code> for more information.</p>

<h4 id="data-evaluate">data: evaluate</h4>

<p>&hellip;</p>

<h2 id="subscribe-to-expressions">Subscribe To Expressions</h2>

<h3 id="http-request">HTTP Request</h3>

<p><code class="prettyprint">POST http://&lt;INSTANCE-ENDPOINT&gt;/lwc/api/v1/subscribe</code></p>

<h3 id="example-request">Example Request</h3>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"streamId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"foo"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"frequency"</span><span class="p">:</span><span class="w"> </span><span class="mi">60000</span><span class="p">,</span><span class="w">
  </span><span class="nt">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://..."</span><span class="p">,</span><span class="w">
  </span><span class="nt">"expressions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"expression"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nf.cluster,skan-test,:eq,name,totalCpu,:eq,:and,:avg"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"frequency"</span><span class="p">:</span><span class="w"> </span><span class="mi">10000</span><span class="p">,</span><span class="w">
      </span><span class="nt">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://..."</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<table><thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>streamId</td>
<td>The streamId to snd data for these expressions to.</td>
</tr>
<tr>
<td>frequency</td>
<td>How often clients are requested to send this data, in milliseconds.  If omitted, a default is used.  If specified at the top level, it supplies a default for all expressions.</td>
</tr>
<tr>
<td>url</td>
<td>The URL the client should use to submit data.  This is generally unneeded, and should not be used without consulting the Atlas team.</td>
</tr>
</tbody></table>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="json">json</a>
          </div>
      </div>
    </div>
  </body>
</html>
